networks:
  demo:

x-n8n: &service-n8n
  build:
    context: .
    dockerfile: Dockerfile.n8n
  networks: ['demo']
  environment:
    - DB_TYPE=postgresdb
    - DB_POSTGRESDB_HOST=postgres
    - DB_POSTGRESDB_PORT=5432
    - DB_POSTGRESDB_DATABASE=n8n
    - DB_POSTGRESDB_USER=root
    - DB_POSTGRESDB_PASSWORD=password
    - N8N_DIAGNOSTICS_ENABLED=false
    - N8N_PERSONALIZATION_ENABLED=false
    - N8N_ENCRYPTION_KEY=super-secret-key
    - N8N_USER_MANAGEMENT_JWT_SECRET=even-more-secret
    - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
    - VLLM_HOST=vllm:8000
    - WEBHOOK_URL=http://n8n:5678
    - N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true
    - N8N_LOG_LEVEL=debug

services:

  openwebui-import:
    image: alpine:3.20
    container_name: openwebui-import
    networks: ['demo']
    volumes:
      - ./data/openwebui:/app/backend/data
      - ./openwebui:/init-data:ro
    command: [
      "/bin/sh", "-c",
      "if [ ! -f /app/backend/data/webui.db ]; then \
         echo 'Copy webui.db in volumeâ€¦'; \
         cp /init-data/webui.db /app/backend/data/webui.db; \
       else \
         echo 'webui.db already initialized.'; \
       fi"
    ]
    restart: "no"

  postgres:
    image: postgres:17-alpine
    hostname: postgres
    container_name: postgres
    networks: ['demo']
    restart: unless-stopped
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=n8n
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -h localhost -U root -d n8n']
      interval: 5s
      timeout: 5s
      retries: 10

  pgadmin:
    image: dpage/pgadmin4:latest
    hostname: pgadmin
    container_name: pgadmin
    networks: ['demo']
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@admin.com
      - PGADMIN_DEFAULT_PASSWORD=password
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
    ports:
      - 5050:80
    volumes:
      - ./data/pgadmin:/var/lib/pgadmin
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro
      - ./pgadmin/pgpassfile:/pgpass:ro
    entrypoint: >
      /bin/sh -c "
      chmod 600 /pgpass;
      /entrypoint.sh
      "
    depends_on:
      postgres:
        condition: service_healthy

  n8n-import:
    <<: *service-n8n
    hostname: n8n-import
    container_name: n8n-import
    entrypoint: /bin/sh
    command:
      - "-c"
      - "n8n import:credentials --separate --input=/backup/credentials && n8n import:workflow --separate --input=/backup/workflows"
    volumes:
      - ./n8n/backup:/backup
    depends_on:
      postgres:
        condition: service_healthy

  n8n:
    <<: *service-n8n
    hostname: n8n
    container_name: n8n
    restart: unless-stopped
    ports:
      - 5678:5678
    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./n8n/backup:/backup
      - ./shared:/data/shared
      - ./logs:/data/logs:ro
    depends_on:
      postgres:
        condition: service_healthy
      n8n-import:
        condition: service_completed_successfully

  qdrant:
    image: qdrant/qdrant:latest
    hostname: qdrant
    container_name: qdrant
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 6333:6333
    volumes:
      - ./data/qdrant:/qdrant/storage

  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui
    hostname: openwebui
    networks: ['demo']
    restart: unless-stopped
    environment:
      - RESET_CONFIG_ON_START=false
      - WEBUI_URL=http://openwebui:8080
    ports:
      - 3000:8080
    volumes:
      - ./data/openwebui:/app/backend/data
    depends_on:
      openwebui-import:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 10s
      timeout: 5s
      retries: 5

  vllm-cpu:
    profiles: ["cpu"]
    image: vllm/vllm-openai:latest
    container_name: vllm-cpu
    hostname: vllm
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 8000:8000
    environment:
      - VLLM_CPU_ONLY=1
      - HUGGING_FACE_HUB_TOKEN=${HUGGING_FACE_HUB_TOKEN:-}
    volumes:
      - ./data/vllm:/root/.cache/huggingface
    command:
      - "--model"
      - "facebook/opt-125m"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8000"
    ipc: host

  vllm-gpu:
    profiles: ["gpu"]
    image: vllm/vllm-openai:latest
    container_name: vllm-gpu
    hostname: vllm
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 8000:8000
    environment:
      - HUGGING_FACE_HUB_TOKEN=${HUGGING_FACE_HUB_TOKEN:-}
    volumes:
      - ./data/vllm:/root/.cache/huggingface
    command:
      - "--model"
      - "facebook/opt-125m"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8000"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    ipc: host
    shm_size: 4gb

  jira:
    image: cptactionhank/atlassian-jira:latest
    hostname: jira
    container_name: jira
    networks: ['demo']
    restart: unless-stopped
    ports:
      - 8080:8080
    volumes:
      - ./data/jira:/var/atlassian/jira

  mcp-server:
    image: ghcr.io/sooperset/mcp-atlassian:latest
    container_name: mcp-server
    hostname: mcp-server
    restart: unless-stopped
    networks: ['demo']
    ports:
      - 5000:3000
    command:
      - "--transport"
      - "sse"
      - "--port"
      - "3000"
      - "-vv"
    environment:
      - ENABLED_TOOLS=jira,jira_search,jira_create_issue,jira_update_issue,jira_transition_issue,jira_add_comment
      - JIRA_URL=http://jira:8080
      - JIRA_USERNAME=your_jira_username
      - JIRA_PERSONAL_TOKEN=your_personal_access_token
      - JIRA_PROJECT=project_key
      - MCP_VERBOSE=true
      - JIRA_SSL_VERIFY=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 5

  # logfile-writer service removed - was only for testing
  # To add a test log service, create a test.log file first
